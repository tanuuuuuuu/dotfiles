# CLAUDE.md ベストプラクティス

## 設計思想

CLAUDE.md はエージェント向けのオンボーディング文書。新しいエンジニアがチームに参加したときに伝える「コードからは読み取れない暗黙知」を記述する場所。

コードと同じようにメンテナンスする — 定期的にレビューし、不要になった項目を削除し、変更後に Claude の挙動が改善したか確認する。

## 構成の原則

### WHAT（何のプロジェクトか）

- 技術スタック（言語、フレームワーク、主要ライブラリ）
- プロジェクト構造（重要なディレクトリとその役割）
- 目的（1-2文で簡潔に）

### HOW（どう作業するか）

- ビルド/テストコマンド（単一テスト実行の方法も含む）
- 開発時の注意点・落とし穴
- コード規約（linter/formatter で対応できないもののみ）
- ブランチ命名規約、PR/コミットの慣習

## アンチパターン

| 避けるべきこと | 理由 | 代替手段 |
|---|---|---|
| コードスニペットの埋め込み | 古くなりやすい | ファイルパスや `@import` で参照 |
| 詳細なセットアップ手順 | README.md の領域 | `@README.md` でリンク |
| タスク固有の指示 | 毎セッション読み込まれるため無駄 | スキル（`.claude/skills/`）に分離 |
| linter/formatter で対応可能な規約 | ツールに任せるべき | ESLint, Biome, ruff 等で設定 |
| 過度な強調表現の乱用 | 本当に重要なものが埋もれる | 「IMPORTANT」は2-3箇所まで |
| `/init` で自動生成したまま放置 | 判断根拠や文脈が欠落 | 生成後に手動で精査・編集 |
| コードを読めばわかること | コンテキストの無駄遣い | 削除する |
| 「きれいなコードを書け」等の自明な指示 | Claude は既に知っている | 削除する |

## リトマス試験

各行について以下を自問する:

1. **「この行を消したら Claude がミスするか？」** → No なら削除
2. **「linter やフォーマッターで自動化できるか？」** → Yes ならツールに任せる
3. **「毎回のセッションで必要か？」** → No ならスキルに分離
4. **「README.md に書くべき内容か？」** → Yes なら CLAUDE.md からは削除

## チェックリスト

### 必須項目
- [ ] 技術スタックが明記されている
- [ ] 主要なディレクトリ構造がわかる
- [ ] ビルド/テスト方法が記載されている（単一テスト実行含む）

### 品質項目
- [ ] 60行以下（理想）/ 300行以下（最大）
- [ ] コードスニペットを含んでいない（ファイル参照に置き換え済み）
- [ ] README.md と重複していない
- [ ] 毎セッションで普遍的に適用される情報のみ
- [ ] linter/formatter でカバーされる規約を含んでいない
- [ ] 「IMPORTANT」「MUST」等の強調は本当に重要な箇所だけに限定
- [ ] 古くなった情報がない（定期的にレビュー）

### 構造項目
- [ ] WHAT → HOW の順序で構成されている
- [ ] 300行を超える場合は `@import` で分割されている
- [ ] プロジェクトの言語に合わせて書かれている

## 長くなった場合の対処法

### `@import` 構文による分割

CLAUDE.md から外部ファイルを参照できる。Claude は必要に応じて読み込む。

```markdown
# プロジェクト概要
TypeScript + React のWebアプリケーション。

# コマンド
- ビルド: `npm run build`
- テスト: `npm test -- path/to/file`

# 追加リソース
- Git ワークフロー: @docs/git-workflow.md
- API 設計規約: @docs/api-conventions.md
```

### スキルへの分離

特定のタスクでのみ必要な知識は、CLAUDE.md ではなくスキル（`.claude/skills/`）に配置する。スキルは関連するタスクのときだけ読み込まれるため、毎セッションのコンテキスト消費を減らせる。

例: 「デプロイ手順」は毎セッション必要ではないので、スキルに分離する。

### フックの活用

「絶対に例外なく実行すべきこと」（lint チェック、ファイル編集後のフォーマット等）は、CLAUDE.md の指示よりもフック（`.claude/settings.json` の hooks）の方が確実。フックは指示を無視されるリスクがない。

## 配置場所

| 場所 | 用途 | git 管理 |
|------|------|----------|
| `プロジェクトルート/CLAUDE.md` | チーム共有のプロジェクト固有ルール | する |
| `プロジェクトルート/CLAUDE.local.md` | 個人的なプロジェクト設定 | しない（.gitignore） |
| `~/.claude/CLAUDE.md` | 全プロジェクト共通の個人設定 | 任意 |
| 親ディレクトリの `CLAUDE.md` | モノレポのルート設定 | する |
| サブディレクトリの `CLAUDE.md` | そのディレクトリ固有のルール（オンデマンド読み込み） | する |

## 強調表現のガイドライン

Claude の注意を引くための強調表現（「IMPORTANT」「YOU MUST」等）は効果的だが、使いすぎると逆効果になる。

- **使うべき場面**: データ損失やセキュリティに関わるルール、過去に繰り返し違反があった項目
- **使うべきでない場面**: 一般的なコーディング規約、好みレベルの指示
- **目安**: CLAUDE.md 全体で 2-3 箇所まで

## 良い例・悪い例

### 良い例

```markdown
# MyApp
React + TypeScript の SaaS アプリケーション。

## コマンド
- ビルド: `npm run build`
- テスト: `npm test -- --testPathPattern=<file>`
- lint: `npm run lint`

## 規約
- API レスポンスは必ず `ApiResponse<T>` 型でラップする
- 環境変数は `src/config.ts` で一元管理。直接 `process.env` を参照しない
- DB マイグレーションは `npm run migrate:create <name>` で作成

## 注意点
- IMPORTANT: `users` テーブルには直接 DELETE を実行しない（soft delete のみ）
```

### 悪い例

```markdown
# MyApp

## セットアップ（← README.md に書くべき）
1. Node.js 18 をインストール
2. npm install を実行
3. .env.example を .env にコピー
...

## コードスタイル（← linter に任せるべき）
- セミコロンを使う
- インデントは2スペース
- シングルクォートを使う

## IMPORTANT: テストを書くこと（← 自明すぎる）
## IMPORTANT: 型安全にすること（← 自明すぎる）
## IMPORTANT: エラーハンドリングを忘れずに（← 自明すぎる）
```

## 参考リンク

- https://code.claude.com/docs/en/best-practices
- https://code.claude.com/docs/en/memory
- https://www.humanlayer.dev/blog/writing-a-good-claude-md
- https://www.tembo.io/blog/how-to-write-a-great-claude-md
- https://www.builder.io/blog/claude-md-guide
